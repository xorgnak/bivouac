load 'lib/get.rb'
load 'lib/post.rb'
module Bivouac
  class Httpd < Sinatra::Base
    configure do
      set :server, 'thin'
      set :views, %[#{Dir.pwd}/views]
      set :public_folder, %[#{Dir.pwd}/public]
      set :bind, '0.0.0.0'
      set :port, 4567
    end
    before do
      if /\d+.\d+.\d+.\d+/.match(request.host) || request.host == 'localhost'
        @path = 'localhost'
        @url = "http://#{@path}"
      else
        @path = request.host
        @url = "https://#{@path}"
      end
      @host = Host.new(@path)
      @app = Bivouac::Get.new(@path, request, params);
    end
    get('/') { @id = id(params[:id]); erb :index }
    get('/:entity') { @user = @host[params[:entity]]; erb :entity }
    get('/:entity/:app') { @user = @host[params[:entity]]; @zone = @host[params[:entity]][params[:app]]; erb :app }
    post('/auth') { @auth = Bivouac::Auth.new(@path, request, params); erb :auth }
    post('/box') { b = Bivouac::Remote.new(@path, request, params); redirect b.goto }
    post('/:entity') {
      if "#{params[:entity]}".length > 0
        # handle file upload
      end
      b = Bivouac::Post.new(@path, request, params)
      redirect "#{@path}/#{b.goto}"
    }
  end
end
